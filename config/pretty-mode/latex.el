(defun substitute-pattern-with-unicode (pattern symbol)
  (interactive)
  (font-lock-add-keywords
   nil `((, pattern (0 (progn
			 (compose-region
			  (match-beginning 1)
			  (match-end 1),
			  symbol
			  'decompose-region)
			 nil))))))

(defun substitute-patterns-with-unicode (patterns)
  (mapcar #'(lambda (x)
	      (substitute-pattern-with-unicode (car x) (cdr x)))
	  patterns))

(defun pretty-mode/latex/simple-cmd-regex (cmd)
  (concat
   (concat "\\(\\\\" cmd)
   "\\)[_^\\\n]"))

(defun pretty-mode/latex/simple-cmd-regexes (cmds)
  (mapcar #'(lambda (x)
	      (cons (pretty-mode/latex/simple-cmd-regex (car x)) (cdr x)))
	  cmds))

(defun pretty-mode/latex/greek-small ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-cmd-regexes
    (list (cons "alpha"   ?α)
	  (cons "beta"    ?β)
	  (cons "gamma"   ?γ)
	  (cons "delta"   ?δ)
	  (cons "epsilon" ?ε)
	  (cons "zeta"    ?ζ)
	  (cons "eta"     ?η)
	  (cons "theta"   ?θ)
	  (cons "iota"    ?ι)
	  (cons "kappa"   ?κ)
	  (cons "lambda"  ?λ)
	  (cons "mu"      ?μ)
	  (cons "nu"      ?ν)
	  (cons "xi"      ?ξ)
	  (cons "omicron" ?ο)
	  (cons "pi"      ?π)
	  (cons "rho"     ?ρ)
	  (cons "sigma"   ?σ)
	  (cons "tau"     ?τ)
	  (cons "upsilon" ?υ)
	  (cons "varphi"  ?φ)
	  (cons "phi"     ?ϕ)
	  (cons "chi"     ?χ)
	  (cons "psi"     ?ψ)
	  (cons "omega"   ?ω)))))

(defun pretty-mode/latex/greek-capital ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-cmd-regexes
    (list (cons "Alpha"   ?Α)
	  (cons "Beta"    ?Β)
	  (cons "Gamma"   ?Γ)
	  (cons "Delta"   ?Δ)
	  (cons "Epsilon" ?Ε)
	  (cons "Zeta"    ?Ζ)
	  (cons "Eta"     ?Η)
	  (cons "Theta"   ?Θ)
	  (cons "Iota"    ?Ι)
	  (cons "Kappa"   ?Κ)
	  (cons "Lambda"  ?Λ)
	  (cons "Mu"      ?Μ)
	  (cons "Nu"      ?Ν)
	  (cons "Xi"      ?Ξ)
	  (cons "Omicron" ?Ο)
	  (cons "Pi"      ?Π)
	  (cons "Rho"     ?Ρ)
	  (cons "Sigma"   ?Σ)
	  (cons "Tau"     ?Τ)
	  (cons "Upsilon" ?Υ)
	  (cons "Phi"     ?Φ)
	  (cons "Chi"     ?Χ)
	  (cons "Psi"     ?Ψ)
	  (cons "Omega"   ?Ω)))))

(defun pretty-mode/latex/binary-operators ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-cmd-regexes
    (list
     (cons "pm"              ?±)
     (cons "mp"              ?∓)
     (cons "times"           ?×)
     (cons "circ"            ?⚬)
     (cons "bullet"          ?•)
     (cons "cap"             ?∩)
     (cons "sqcap"           ?⊓)
     (cons "sqcup"           ?⊔)
     (cons "vee"             ?∨)
     (cons "wedge"           ?∧)
     (cons "setminus"        ?∖)
     (cons "diamond"         ?◇)
     (cons "bigtriangleup"   ?△)
     (cons "bigtriangledown" ?▽)
     (cons "triangleleft"    ?◃)
     (cons "triangleright"   ?▹)
     (cons "lhd"             ?◁)
     (cons "rhd"             ?▷)
     (cons "oplus"           ?⊕)
     (cons "otimes"          ?⊗)
     (cons "odot"            ?⊙)
     (cons "bigcirc"         ?◯)
     (cons "dagger"          ?†)
     (cons "ddagger"         ?‡)
     (cons "amalg"           ?⨿)))))

(defun pretty-mode/latex/relations ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-cmd-regexes
    (list
     (cons "leq"        ?≤)
     (cons "prec"       ?≺)
     (cons "preceq"     ?⪯)
     (cons "ll"         ?≪)
     (cons "subset"     ?⊂)
     (cons "subseteq"   ?⊆)
     (cons "sqsubset"   ?⊏)
     (cons "sqsubset"   ?⊑)
     (cons "in"         ?∈)
     (cons "vdash"      ?⊦)
     (cons "geq"        ?≥)
     (cons "succ"       ?≻)
     (cons "succeq"     ?⪰)
     (cons "gg"         ?≫)
     (cons "supset"     ?⊃)
     (cons "supseteq"   ?⊇)
     (cons "supset"     ?⊐)
     (cons "sqsupseteq" ?⊒)
     (cons "ni"         ?∋)
     (cons "dashv"      ?⊣)
     (cons "equiv"      ?≡)
     (cons "sim"        ?~)
     (cons "simeq"      ?≃)
     (cons "asymp"      ?≍)
     (cons "approx"     ?≈)
     (cons "cong"       ?≅)
     (cons "neq"        ?≠)
     (cons "doteq"      ?≐)
     (cons "propto"     ?∝)
     (cons "models"     ?⊨)
     (cons "perp"       ?⟘)
     (cons "mid"        ?∣)
     (cons "parallel"   ?∥)
     (cons "nparallel"  ?∦)
     (cons "bowtie"     ?⋈)
     (cons "join"       ?⨝)
     (cons "smile"      ?⌣)
     (cons "frown"      ?⌢)))))

(defun pretty-mode/latex/arrows ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-cmd-regexes
    (list
     (cons "leftarrow"         ?←)
     (cons "rightarrow"        ?→)
     (cons "uparrow"           ?↑)
     (cons "downarrow"         ?↓)
     (cons "Leftarrow"         ?⇐)
     (cons "Rightarrow"        ?⇒)
     (cons "Uparrow"           ?⇑)
     (cons "Downarrow"         ?⇓)
     (cons "leftrightarrow"    ?↔)
     (cons "updownarrow"       ?↕)
     (cons "Leftrightarrow"    ?⇔)
     (cons "Updownarrow"       ?⇕)
     (cons "mapsto"            ?↦)
     (cons "hookleftarrow"     ?↩)
     (cons "hookrightarrow"    ?↪)
     (cons "leftharpoonup"     ?↼)
     (cons "leftharpoondown"   ?↽)
     (cons "rightharpoonup"    ?⇀)
     (cons "rightharpoondown"  ?⇁)
     (cons "rightleftharpoons" ?⇌)
     (cons "leftrightharpoons" ?⇋)
     (cons "leadsto"           ?⤳)
     (cons "nearrow"           ?↗)
     (cons "searrow"           ?↘)
     (cons "swarrow"           ?↙)
     (cons "nwarrow"           ?↖)))))

(defun pretty-mode/latex/misc ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-cmd-regexes
    (list
     (cons "ldots"    ?…)
     (cons "cdots"    ?⋯)
     (cons "vdots"    ?⋮)
     (cons "ddots"    ?⋱)
     (cons "alpeh"    ?ℵ)
     (cons "hbar"     ?ℏ)
     (cons "emptyset" ?∅)
     (cons "nabla"    ?∇)
     (cons "surd"     ?√)
     (cons "sqrt"     ?√)
     (cons "top"      ?⊤)
     (cons "bot"      ?⊥)
     (cons "forall"   ?∀)
     (cons "exists"   ?∃)
     (cons "neg"      ?¬)
     (cons "partial"  ?∂)
     (cons "infty"    ?∞)
     (cons "Box"      ?☐)
     (cons "int"      ?∫)
     (cons "sum"      ?∑)
     ))))


(defun pretty-mode/latex ()
  "Prettify symbols in LaTex mode."
  (pretty-mode/latex/greek-small)
  (pretty-mode/latex/greek-capital)
  (pretty-mode/latex/binary-operators)
  (pretty-mode/latex/relations)
  (pretty-mode/latex/arrows)
  (pretty-mode/latex/misc))

(add-hook 'tex-mode-hook 'pretty-mode/latex)
(add-hook 'latex-mode-hook 'pretty-mode/latex)
(add-hook 'org-mode-hook 'pretty-mode/latex)
