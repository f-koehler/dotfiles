(defun substitute-pattern-with-unicode (pattern symbol)
  (interactive)
  (font-lock-add-keywords
   nil `((, pattern (0 (progn
			 (compose-region
			  (match-beginning 1)
			  (match-end 1),
			  symbol
			  'decompose-region)
			 nil))))))

(defun substitute-patterns-with-unicode (patterns)
  (mapcar #'(lambda (x)
	      (substitute-pattern-with-unicode (car x) (cdr x)))
	  patterns))

(defun pretty-mode/latex/simple-regex (cmd)
  (concat
   (concat "\\(\\\\" cmd)
   "\\)[_^\\\n \t]"))

(defun pretty-mode/latex/simple-regexes (cmds)
  (mapcar #'(lambda (x)
	      (cons (pretty-mode/latex/simple-regex (car x)) (cdr x)))
	  cmds))

(defun pretty-mode/latex/mathcal-regex (letter)
  (concat
   (concat "\\(\\\\mathcal{" letter)
   "}\\)[_^\\\n \t]"))

(defun pretty-mode/latex/mathcal-regexes (letters)
  (mapcar #'(lambda (x)
	      (cons (pretty-mode/latex/mathcal-regex (car x)) (cdr x)))
	  letters))

(defun pretty-mode/latex/mathbb-regex (letter)
  (concat
   (concat "\\(\\\\mathbb{" letter)
   "}\\)[_^\\\n \t]"))

(defun pretty-mode/latex/mathbb-regexes (letters)
  (mapcar #'(lambda (x)
	      (cons (pretty-mode/latex/mathbb-regex (car x)) (cdr x)))
	  letters))

(defun pretty-mode/latex/mathfrak-regex (letter)
  (concat
   (concat "\\(\\\\mathfrak{" letter)
   "}\\)[_^\\\n \t]"))

(defun pretty-mode/latex/mathfrak-regexes (letters)
  (mapcar #'(lambda (x)
	      (cons (pretty-mode/latex/mathfrak-regex (car x)) (cdr x)))
	  letters))

(defun pretty-mode/latex/greek-small ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-regexes
    (list (cons "alpha"   ?Î±)
	  (cons "beta"    ?Î²)
	  (cons "gamma"   ?Î³)
	  (cons "delta"   ?Î´)
	  (cons "epsilon" ?Îµ)
	  (cons "zeta"    ?Î¶)
	  (cons "eta"     ?Î·)
	  (cons "theta"   ?Î¸)
	  (cons "iota"    ?Î¹)
	  (cons "kappa"   ?Îº)
	  (cons "lambda"  ?Î»)
	  (cons "mu"      ?Î¼)
	  (cons "nu"      ?Î½)
	  (cons "xi"      ?Î¾)
	  (cons "omicron" ?Î¿)
	  (cons "pi"      ?Ï€)
	  (cons "rho"     ?Ï)
	  (cons "sigma"   ?Ïƒ)
	  (cons "tau"     ?Ï„)
	  (cons "upsilon" ?Ï…)
	  (cons "varphi"  ?Ï†)
	  (cons "phi"     ?Ï•)
	  (cons "chi"     ?Ï‡)
	  (cons "psi"     ?Ïˆ)
	  (cons "omega"   ?Ï‰)))))

(defun pretty-mode/latex/greek-capital ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-regexes
    (list (cons "Alpha"   ?Î‘)
	  (cons "Beta"    ?Î’)
	  (cons "Gamma"   ?Î“)
	  (cons "Delta"   ?Î”)
	  (cons "Epsilon" ?Î•)
	  (cons "Zeta"    ?Î–)
	  (cons "Eta"     ?Î—)
	  (cons "Theta"   ?Î˜)
	  (cons "Iota"    ?Î™)
	  (cons "Kappa"   ?Îš)
	  (cons "Lambda"  ?Î›)
	  (cons "Mu"      ?Îœ)
	  (cons "Nu"      ?Î)
	  (cons "Xi"      ?Î)
	  (cons "Omicron" ?ÎŸ)
	  (cons "Pi"      ?Î )
	  (cons "Rho"     ?Î¡)
	  (cons "Sigma"   ?Î£)
	  (cons "Tau"     ?Î¤)
	  (cons "Upsilon" ?Î¥)
	  (cons "Phi"     ?Î¦)
	  (cons "Chi"     ?Î§)
	  (cons "Psi"     ?Î¨)
	  (cons "Omega"   ?Î©)))))

(defun pretty-mode/latex/cal-small ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/mathcal-regexes
    (list (cons "g" ?â„Š)
	  (cons "l" ?â„“)
	  (cons "e" ?â„¯)))))

(defun pretty-mode/latex/cal-capital ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/mathcal-regexes
    (list (cons "B" ?â„¬)
	  (cons "E" ?â„°)
	  (cons "F" ?â„±)
	  (cons "H" ?â„‹)
	  (cons "I" ?â„)
	  (cons "L" ?â„’)
	  (cons "M" ?â„³)
	  (cons "R" ?â„›)
	  (cons "V" ?Æ²)))))

(defun pretty-mode/latex/blackboard ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/mathbb-regexes
    (list (cons "A" ?ğ”¸)
	  (cons "B" ?ğ”¹)
	  (cons "C" ?â„‚)
	  (cons "D" ?ğ”»)
	  (cons "E" ?ğ”¼)
	  (cons "F" ?ğ”½)
	  (cons "G" ?ğ”¾)
	  (cons "H" ?â„)
	  (cons "I" ?ğ•€)
	  (cons "J" ?ğ•)
	  (cons "K" ?ğ•‚)
	  (cons "L" ?ğ•ƒ)
	  (cons "M" ?ğ•„)
	  (cons "N" ?â„•)
	  (cons "O" ?ğ•†)
	  (cons "P" ?â„™)
	  (cons "Q" ?â„š)
	  (cons "R" ?â„)
	  (cons "S" ?ğ•Š)
	  (cons "T" ?ğ•‹)
	  (cons "U" ?ğ•Œ)
	  (cons "V" ?ğ•)
	  (cons "W" ?ğ•)
	  (cons "X" ?ğ•)
	  (cons "X" ?ğ•)
	  (cons "Z" ?â„¤)
	  (cons "a" ?ğ•’)
	  (cons "b" ?ğ•“)
	  (cons "c" ?ğ•”)
	  (cons "d" ?ğ••)
	  (cons "e" ?ğ•–)
	  (cons "f" ?ğ•—)
	  (cons "g" ?ğ•˜)
	  (cons "h" ?ğ•™)
	  (cons "i" ?ğ•š)
	  (cons "j" ?ğ•›)
	  (cons "k" ?ğ•œ)
	  (cons "l" ?ğ•)
	  (cons "m" ?ğ•)
	  (cons "n" ?ğ•Ÿ)
	  (cons "o" ?ğ• )
	  (cons "p" ?ğ•¡)
	  (cons "q" ?ğ•¢)
	  (cons "r" ?ğ•£)
	  (cons "s" ?ğ•¤)
	  (cons "t" ?ğ•¥)
	  (cons "u" ?ğ•¦)
	  (cons "v" ?ğ•§)
	  (cons "w" ?ğ•¨)
	  (cons "x" ?ğ•©)
	  (cons "x" ?ğ•ª)
	  (cons "z" ?ğ•«)
	  (cons "0" ?ğŸ˜)
	  (cons "1" ?ğŸ™)
	  (cons "2" ?ğŸš)
	  (cons "3" ?ğŸ›)
	  (cons "4" ?ğŸœ)
	  (cons "5" ?ğŸ)
	  (cons "6" ?ğŸ)
	  (cons "7" ?ğŸŸ)
	  (cons "8" ?ğŸ )
	  (cons "9" ?ğŸ¡))))

(defun pretty-mode/latex/binary-operators ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-regexes
    (list
     (cons "pm"              ?Â±)
     (cons "mp"              ?âˆ“)
     (cons "times"           ?Ã—)
     (cons "circ"            ?âš¬)
     (cons "bullet"          ?â€¢)
     (cons "cap"             ?âˆ©)
     (cons "sqcap"           ?âŠ“)
     (cons "sqcup"           ?âŠ”)
     (cons "vee"             ?âˆ¨)
     (cons "wedge"           ?âˆ§)
     (cons "setminus"        ?âˆ–)
     (cons "diamond"         ?â—‡)
     (cons "bigtriangleup"   ?â–³)
     (cons "bigtriangledown" ?â–½)
     (cons "triangleleft"    ?â—ƒ)
     (cons "triangleright"   ?â–¹)
     (cons "lhd"             ?â—)
     (cons "rhd"             ?â–·)
     (cons "oplus"           ?âŠ•)
     (cons "otimes"          ?âŠ—)
     (cons "odot"            ?âŠ™)
     (cons "bigcirc"         ?â—¯)
     (cons "dagger"          ?â€ )
     (cons "ddagger"         ?â€¡)
     (cons "amalg"           ?â¨¿)))))

(defun pretty-mode/latex/relations ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-regexes
    (list
     (cons "leq"        ?â‰¤)
     (cons "prec"       ?â‰º)
     (cons "preceq"     ?âª¯)
     (cons "ll"         ?â‰ª)
     (cons "subset"     ?âŠ‚)
     (cons "subseteq"   ?âŠ†)
     (cons "sqsubset"   ?âŠ)
     (cons "sqsubset"   ?âŠ‘)
     (cons "in"         ?âˆˆ)
     (cons "vdash"      ?âŠ¦)
     (cons "geq"        ?â‰¥)
     (cons "succ"       ?â‰»)
     (cons "succeq"     ?âª°)
     (cons "gg"         ?â‰«)
     (cons "supset"     ?âŠƒ)
     (cons "supseteq"   ?âŠ‡)
     (cons "supset"     ?âŠ)
     (cons "sqsupseteq" ?âŠ’)
     (cons "ni"         ?âˆ‹)
     (cons "dashv"      ?âŠ£)
     (cons "equiv"      ?â‰¡)
     (cons "sim"        ?~)
     (cons "simeq"      ?â‰ƒ)
     (cons "asymp"      ?â‰)
     (cons "approx"     ?â‰ˆ)
     (cons "cong"       ?â‰…)
     (cons "neq"        ?â‰ )
     (cons "doteq"      ?â‰)
     (cons "propto"     ?âˆ)
     (cons "models"     ?âŠ¨)
     (cons "perp"       ?âŸ˜)
     (cons "mid"        ?âˆ£)
     (cons "parallel"   ?âˆ¥)
     (cons "nparallel"  ?âˆ¦)
     (cons "bowtie"     ?â‹ˆ)
     (cons "join"       ?â¨)
     (cons "smile"      ?âŒ£)
     (cons "frown"      ?âŒ¢)))))

(defun pretty-mode/latex/arrows ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-regexes
    (list
     (cons "leftarrow"         ?â†)
     (cons "rightarrow"        ?â†’)
     (cons "uparrow"           ?â†‘)
     (cons "downarrow"         ?â†“)
     (cons "Leftarrow"         ?â‡)
     (cons "Rightarrow"        ?â‡’)
     (cons "Uparrow"           ?â‡‘)
     (cons "Downarrow"         ?â‡“)
     (cons "leftrightarrow"    ?â†”)
     (cons "updownarrow"       ?â†•)
     (cons "Leftrightarrow"    ?â‡”)
     (cons "Updownarrow"       ?â‡•)
     (cons "mapsto"            ?â†¦)
     (cons "hookleftarrow"     ?â†©)
     (cons "hookrightarrow"    ?â†ª)
     (cons "leftharpoonup"     ?â†¼)
     (cons "leftharpoondown"   ?â†½)
     (cons "rightharpoonup"    ?â‡€)
     (cons "rightharpoondown"  ?â‡)
     (cons "rightleftharpoons" ?â‡Œ)
     (cons "leftrightharpoons" ?â‡‹)
     (cons "leadsto"           ?â¤³)
     (cons "nearrow"           ?â†—)
     (cons "searrow"           ?â†˜)
     (cons "swarrow"           ?â†™)
     (cons "nwarrow"           ?â†–)))))

(defun pretty-mode/latex/misc ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-regexes
    (list
     (cons "ldots"    ?â€¦)
     (cons "cdots"    ?â‹¯)
     (cons "vdots"    ?â‹®)
     (cons "ddots"    ?â‹±)
     (cons "alpeh"    ?â„µ)
     (cons "hbar"     ?â„)
     (cons "emptyset" ?âˆ…)
     (cons "nabla"    ?âˆ‡)
     (cons "surd"     ?âˆš)
     (cons "sqrt"     ?âˆš)
     (cons "top"      ?âŠ¤)
     (cons "bot"      ?âŠ¥)
     (cons "forall"   ?âˆ€)
     (cons "exists"   ?âˆƒ)
     (cons "neg"      ?Â¬)
     (cons "partial"  ?âˆ‚)
     (cons "infty"    ?âˆ)
     (cons "Box"      ?â˜)
     (cons "int"      ?âˆ«)
     (cons "sum"      ?âˆ‘)
     (cons "prod"     ?âˆ)))))

(defun pretty-mode/latex/integrals ()
  (interactive)
  (substitute-patterns-with-unicode
   (pretty-mode/latex/simple-regexes
    (list
     (cons "int\\\\int\\\\int\\\\int" ?â¨Œ)
     (cons "int\\\\int\\\\int" ?âˆ­)
     (cons "int\\\\int" ?âˆ¬)
     (cons "int" ?âˆ«)
     (cons "iiiint" ?â¨Œ)
     (cons "iiint" ?âˆ­)
     (cons "iint" ?âˆ¬)
     (cons "oint" ?âˆ®)
     (cons "oiint" ?âˆ¯)))))


(defun pretty-mode/latex ()
  "Prettify symbols in LaTex mode."
  (pretty-mode/latex/greek-small)
  (pretty-mode/latex/greek-capital)
  (pretty-mode/latex/cal-small)
  (pretty-mode/latex/cal-capital)
  (pretty-mode/latex/blackboard)
  (pretty-mode/latex/binary-operators)
  (pretty-mode/latex/relations)
  (pretty-mode/latex/arrows)
  (pretty-mode/latex/misc)
  (pretty-mode/latex/integrals))

(add-hook 'tex-mode-hook 'pretty-mode/latex)
(add-hook 'latex-mode-hook 'pretty-mode/latex)
(add-hook 'org-mode-hook 'pretty-mode/latex)
